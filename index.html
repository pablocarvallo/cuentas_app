<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DataApp Sheets CSV</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <link rel="apple-touch-icon" href="casa.png" />
    <meta name="apple-mobile-web-app-title" content="MiData">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }
        body {
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            /* Se añade un margen superior más amplio (2rem + safe-area) */
            padding-top: calc(var(--safe-top) + 2rem);
            background-color: #f9fafb;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            font-size: 18px;
            overflow: hidden; /* Evita scroll elástico del body */
        }
        .tab-content { display: none; height: 100%; }
        .tab-content.active { display: block; }
        .active-tab-btn { color: #2563eb; border-top: 2px solid #2563eb; background-color: #eff6ff; }
        .pb-safe { padding-bottom: var(--safe-bottom); }
        
        .data-row {
            padding: 0.75rem 0.75rem;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            overflow: hidden;
        }
        .data-row:nth-child(even) {
            background-color: #f8fafc;
        }

        .truncate-cell {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: clip;
            flex-shrink: 1;
            margin-right: 8px;
        }

        .value-cell {
            white-space: nowrap;
            flex-shrink: 0;
            text-align: right;
        }
        
        ::-webkit-scrollbar { display: none; }

        /* Contenedor principal para permitir gestos */
        /* Línea 56 - index.html */
#swipe-container {
    height: calc(100vh - var(--safe-top) - var(--safe-bottom) - 10rem); /* Aumentado de 7rem a 10rem */
    overflow-y: auto;
    touch-action: pan-y;
    padding-bottom: 2rem; /* Margen extra interno para asegurar el scroll */
}
      /*  #swipe-container {
            height: calc(100vh - var(--safe-top) - var(--safe-bottom) - 7rem);
            overflow-y: auto;
            touch-action: pan-y; /* Permite scroll vertical pero detectaremos horizontal por JS */
        }*/
    </style>
</head>
<body class="h-screen flex flex-col">

    <main id="swipe-container" class="flex-grow pb-10">
        <div id="loading" class="flex flex-col items-center justify-center py-20">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-2"></div>
            <p class="text-gray-500 text-sm">Cargando...</p>
        </div>
        
        <div id="tab1" class="tab-content active"><div id="content1" class="bg-white"></div></div>
        <div id="tab2" class="tab-content"><div id="content2" class="bg-white"></div></div>
        <div id="tab3" class="tab-content"><div id="content3" class="bg-white"></div></div>
        <div id="tab4" class="tab-content"><div id="content4" class="bg-white"></div></div>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around items-center h-20 pb-safe shadow-[0_-2px_10px_rgba(0,0,0,0.05)]">
        <button onclick="switchTab('tab1')" id="btn-tab1" class="flex flex-col items-center justify-center w-full h-full active-tab-btn transition-colors">
            <span class="text-[10px] font-bold uppercase text-center px-1">Resumen</span>
        </button>
        <button onclick="switchTab('tab2')" id="btn-tab2" class="flex flex-col items-center justify-center w-full h-full text-gray-400 transition-colors border-l">
            <span class="text-[10px] font-bold uppercase text-center px-1">TC</span>
        </button>
        <button onclick="switchTab('tab3')" id="btn-tab3" class="flex flex-col items-center justify-center w-full h-full text-gray-400 transition-colors border-l">
            <span class="text-[10px] font-bold uppercase text-center px-1">Master</span>
        </button>
        <button onclick="switchTab('tab4')" id="btn-tab4" class="flex flex-col items-center justify-center w-full h-full text-gray-400 transition-colors border-l">
            <span class="text-[10px] font-bold uppercase text-center px-1">LiderBCI</span>
        </button>
    </nav>

    <script>
        const URLS = {
            tab1: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT5uXYuDRWuBezPr8wkXCc07mT2DaJQxgYgw0z90JDlS58Io7efeB7KhUpOiALhBtjITBJnNUWJHEKt/pub?gid=189610331&single=true&output=csv',
            tab2: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT5uXYuDRWuBezPr8wkXCc07mT2DaJQxgYgw0z90JDlS58Io7efeB7KhUpOiALhBtjITBJnNUWJHEKt/pub?gid=1170744574&single=true&output=csv',
            tab3: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT5uXYuDRWuBezPr8wkXCc07mT2DaJQxgYgw0z90JDlS58Io7efeB7KhUpOiALhBtjITBJnNUWJHEKt/pub?gid=878224959&single=true&output=csv'
        };

        const tabs = ['tab1', 'tab2', 'tab3', 'tab4'];
        let currentTabIndex = 0;

        function switchTab(tabId) {
            currentTabIndex = tabs.indexOf(tabId);
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('nav button').forEach(el => {
                el.classList.remove('active-tab-btn', 'text-gray-400');
                if (el.id !== 'btn-' + tabId) el.classList.add('text-gray-400');
            });
            document.getElementById(tabId).classList.add('active');
            document.getElementById('btn-' + tabId).classList.add('active-tab-btn');
            
            // Reset scroll position on tab switch
            document.getElementById('swipe-container').scrollTop = 0;
        }

        // Lógica de Swipe
        let touchstartX = 0;
        let touchendX = 0;
        let touchstartY = 0;
        let touchendY = 0;

        const gestureZone = document.getElementById('swipe-container');

        gestureZone.addEventListener('touchstart', e => {
            touchstartX = e.changedTouches[0].screenX;
            touchstartY = e.changedTouches[0].screenY;
        }, {passive: true});

        gestureZone.addEventListener('touchend', e => {
            touchendX = e.changedTouches[0].screenX;
            touchendY = e.changedTouches[0].screenY;
            handleGesture();
        }, {passive: true});

        function handleGesture() {
            const deltaX = touchendX - touchstartX;
            const deltaY = touchendY - touchstartY;

            // Asegurarse de que el movimiento es predominantemente horizontal
            if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 50) {
                if (deltaX < 0) {
                    // Swipe izquierda -> Siguiente pestaña
                    if (currentTabIndex < tabs.length - 1) {
                        switchTab(tabs[currentTabIndex + 1]);
                    }
                } else {
                    // Swipe derecha -> Pestaña anterior
                    if (currentTabIndex > 0) {
                        switchTab(tabs[currentTabIndex - 1]);
                    }
                }
            }
        }

        function formatNumber(val) {
            if (val === null || val === undefined || val === '') return '';
            const cleanVal = val.toString().trim().replace(/[$.]/g, '').replace(',', '.');
            const num = parseFloat(cleanVal);
            if (isNaN(num)) return val;
            return new Intl.NumberFormat('de-DE').format(num);
        }

        function parseCSV(text) {
            const lines = text.split(/\r?\n/);
            return lines.map(line => {
                const values = [];
                let current = '';
                let inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') inQuotes = !inQuotes;
                    else if (char === ',' && !inQuotes) {
                        values.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current.trim());
                return values;
            });
        }

        async function fetchData() {
            try {
                const [resResumen, resTC, resMaster] = await Promise.all([
                    fetch(URLS.tab1).then(r => r.text()),
                    fetch(URLS.tab2).then(r => r.text()),
                    fetch(URLS.tab3).then(r => r.text())
                ]);

                const csvResumen = parseCSV(resResumen);
                const csvTC = parseCSV(resTC);
                const csvMaster = parseCSV(resMaster);

                const dataResumen = csvResumen.slice(0, 7);
                const dataTC = csvTC.slice(0, 11);
                const dataMasterBase = csvMaster.slice(0, 200);

                renderUnified(dataResumen, 'content1', 3, 4);
                renderUnified(dataTC, 'content2', 0, 1);
                renderUnified(dataMasterBase, 'content3', 0, 1);
                renderUnified(dataMasterBase, 'content4', 3, 4);

                document.getElementById('loading').style.display = 'none';
            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('loading').innerHTML = `<div class="p-6 bg-red-50 text-red-600 rounded-xl text-center">Error de conexión</div>`;
            }
        }

        function renderUnified(rows, containerId, labelIdx, valueIdx) {
            const container = document.getElementById(containerId);
            container.innerHTML = rows.map((row, index) => {
                const label = row[labelIdx] || "";
                const rawValue = row[valueIdx] || "";
                if(!label && !rawValue) return "";

                const isHeader = index === 0;
                const valueDisplay = isHeader ? rawValue : formatNumber(rawValue);

                return `
                    <div class="data-row ${isHeader ? 'bg-blue-600 text-white font-bold' : ''}">
                        <span class="truncate-cell ${isHeader ? 'text-white' : 'text-gray-700 font-medium'}">${label}</span>
                        <span class="value-cell ${isHeader ? 'text-white' : 'text-blue-600 font-bold'} font-mono">${valueDisplay}</span>
                    </div>
                `;
            }).join('');
        }

        window.onload = fetchData;
    </script>
</body>
</html>
