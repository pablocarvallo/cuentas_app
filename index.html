<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cuentas</title>
<link rel="manifest" href="manifest.json" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<link rel="apple-touch-icon" href="casa.png" />
<style>
:root{ --azul:#4A90E2; --azul-10:#E8F1FC; --texto:#111; --borde:#e5e5e5; }
*{box-sizing:border-box}
body{ font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif; margin:0; background:#fafafa; color:var(--texto); font-size:17px; line-height:1.4; padding-bottom:64px; }
h2{margin:16px 12px 8px; font-size:20px; font-weight:600}
.table-container{ background:#fff; border-radius:12px; padding:12px; margin:0 12px 16px; box-shadow:0 2px 8px rgba(0,0,0,.08); overflow-x:auto; }
table{width:100%; border-collapse:collapse; font-size:15px}
td,th{border-bottom:1px solid var(--borde); padding:6px 4px}
tr:last-child td{border-bottom:none}
th{background:#f8f8f8; font-weight:700}
td:first-child, th:first-child{ text-align:left }
td:not(:first-child), th:not(:first-child){ text-align:right }
.tabbar{ position:fixed; left:0; right:0; bottom:0; height:64px; display:flex; justify-content:space-around; align-items:center; background:#fff; border-top:1px solid var(--borde); z-index:10; padding-bottom: calc(env(safe-area-inset-bottom) + 15px); box-shadow: 0 -2px 6px rgba(0,0,0,0.05); }
.tabbtn{ flex:1; height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center; gap:4px; color:#555; text-decoration:none; font-size:11px; background:none; border:none; }
.tabbtn svg{ width:22px; height:22px; stroke:#777 }
.tabbtn.active{ color:var(--azul); background:var(--azul-10) }
.tabbtn.active svg{ stroke:var(--azul) }
.view{ display:none; animation:fade .2s ease }
.view.active{ display:block }
@keyframes fade{ from{opacity:.6; transform:translateY(4px)} to{opacity:1; transform:none} }
</style>
</head>
<body>

<div id="view-resumen" class="view active">
  <h2>Resumen</h2>
  <div class="table-container"><table id="tabla_resumen"></table></div>
</div>

<div id="view-tc" class="view">
  <h2>TC</h2>
  <div class="table-container"><table id="tabla_tc"></table></div>
  <h2>TC – detalle adicional</h2>
  <div class="table-container"><table id="tabla_tc_detalle"></table></div>
</div>

<div id="view-compras" class="view">
  <h2>Compras Master</h2>
  <div class="table-container"><table id="tabla_compras"></table></div>
</div>

<nav class="tabbar">
  <button class="tabbtn active" data-target="view-resumen">
    <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M3 9.5 12 3l9 6.5v9A2.5 2.5 0 0 1 18.5 21h-13A2.5 2.5 0 0 1 3 18.5z"/><path d="M9 21V12h6v9"/></svg>
    <span>Resumen</span>
  </button>
  <button class="tabbtn" data-target="view-tc">
    <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M2 9h20"/></svg>
    <span>TC</span>
  </button>
  <button class="tabbtn" data-target="view-compras">
    <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>
    <span>Compras</span>
  </button>
</nav>

<script>
// URL actualizada basada en la nueva dirección proporcionada
const SHEET_BASE = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS1M25_CqR2_NfM3YJ5GzW6E-P6L-i7lXU9E0_S_C6yY_W2_X_X_X/pub"; 
// NOTA: Para que funcione, la hoja DEBE publicarse en la web (Archivo > Compartir > Publicar en la web) como CSV.
// Por ahora, usaremos los GIDs indicados:
const GID_RESUMEN = "189610331";
const GID_TC      = "1170744574";
const GID_COMPRAS = "0"; 

function csvUrl(gid){ return `https://docs.google.com/spreadsheets/d/1S-CSPvJZ_REAoGmdGMVhaZD3cj4OsZpqwtjEzjZoYSw/export?format=csv&gid=${gid}`; }

function parseCSV(text){
  const lines = text.trim().split("\n");
  return lines.map(line=>{
    const out=[], q='"'; let cur="", inQ=false;
    for(let i=0;i<line.length;i++){
      const c=line[i];
      if(c===q && line[i-1]!=='\\'){ inQ=!inQ; continue; }
      if(c===',' && !inQ){ out.push(cur.trim().replace(/^"|"$/g,"")); cur=""; continue; }
      cur+=c;
    }
    out.push(cur.trim().replace(/^"|"$/g,""));
    return out;
  });
}

document.querySelectorAll('.tabbtn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tabbtn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
    document.getElementById(btn.dataset.target).classList.add('active');
  });
});

async function cargarResumen(){
  try {
    const resp=await fetch(csvUrl(GID_RESUMEN));
    const rows=parseCSV(await resp.text());
    const slice=rows.slice(0,7).map(r=>r.slice(3,5));
    document.getElementById("tabla_resumen").innerHTML = 
      slice.map(row=>"<tr>"+row.map(c=>`<td>${c}</td>`).join("")+"</tr>").join("");
  } catch(e){ console.error(e); }
}

async function cargarTC(){
  try {
    const resp=await fetch(csvUrl(GID_TC));
    const rows=parseCSV(await resp.text());
    const top=rows.slice(0,11).map(r=>[r[0]||"", r[r.length-1]||""]);
    document.getElementById("tabla_tc").innerHTML = 
      top.map(row=>"<tr>"+row.map(c=>`<td>${c}</td>`).join("")+"</tr>").join("");
  } catch(e){ console.error(e); }
}

async function cargarComprasMaster(){
  try {
    const resp = await fetch(csvUrl(GID_COMPRAS));
    const text = await resp.text();
    const rows = parseCSV(text);
    if(rows.length <= 1) return;

    const encabezados = rows[0]; [cite: 16]
    
    // FILTRADO CORREGIDO:
    // 1. Usamos trim() para eliminar espacios invisibles.
    // 2. Usamos includes() para que coincida aunque el formato varíe ligeramente.
    const filtrados = rows.slice(1).filter(r => {
      if (!r[4]) return false;
      const bancoVal = r[4].trim();
      return bancoVal.includes("9908") || bancoVal.includes("4526"); [cite: 17]
    });

    let html = "<thead><tr>" + encabezados.map(h => `<th>${h}</th>`).join("") + "</tr></thead><tbody>"; [cite: 17]
    html += filtrados.map(row => "<tr>" + row.map(c => `<td>${c}</td>`).join("") + "</tr>").join(""); [cite: 18]
    html += "</tbody>";
    
    document.getElementById("tabla_compras").innerHTML = html;
  } catch(e){ console.error("Error en filtro:", e); }
}

cargarResumen(); cargarTC(); cargarComprasMaster(); [cite: 19]
setInterval(()=>{ cargarResumen(); cargarTC(); cargarComprasMaster(); }, 300000);
</script>
</body>
</html>
