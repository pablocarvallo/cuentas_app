<script>
const SHEET_BASE = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT5uXYuDRWuBezPr8wkXCc07mT2DaJQxgYgw0z90JDlS58Io7efeB7KhUpOiALhBtjITBJnNUWJHEKt/pub";
const GID_RESUMEN = "189610331";
const GID_TC      = "1170744574";
const GID_GAS     = "724590671";
const GID_HIJAS   = "297279343";

function csvUrl(gid){ return `${SHEET_BASE}?gid=${gid}&single=true&output=csv`; }
function parseCSV(text){
  const lines = text.trim().split("\n");
  return lines.map(line=>{
    const out=[], q='"'; let cur="", inQ=false;
    for(let i=0;i<line.length;i++){
      const c=line[i];
      if(c===q && line[i-1]!=='\\'){ inQ=!inQ; continue; }
      if(c===',' && !inQ){ out.push(cur.trim().replace(/^"|"$/g,"")); cur=""; continue; }
      cur+=c;
    }
    out.push(cur.trim().replace(/^"|"$/g,""));
    return out;
  });
}

// Tabs
document.querySelectorAll('.tabbtn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tabbtn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const target=btn.dataset.target;
    document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
    document.getElementById(target).classList.add('active');
  });
});

// Cargas
async function cargarResumen(){
  const resp=await fetch(csvUrl(GID_RESUMEN));
  const rows=parseCSV(await resp.text());
  const slice=rows.slice(0,4).map(r=>r.slice(3,7));
  document.getElementById("tabla_resumen").innerHTML =
    slice.map(row=>"<tr>"+row.map(c=>`<td>${c}</td>`).join("")+"</tr>").join("");
}
async function cargarTC(){
  const resp=await fetch(csvUrl(GID_TC));
  const rows=parseCSV(await resp.text());
  const top=rows.slice(0,11);
  const principal=top.map(r=>{
    let last=r.length-1;
    for(let i=r.length-1;i>=0;i--){ if(r[i]&&r[i].trim()!==""){ last=i; break; }}
    return [r[0]||"", r[last]||""];
  });
  document.getElementById("tabla_tc").innerHTML =
    principal.map(row=>"<tr>"+row.map(c=>`<td>${c}</td>`).join("")+"</tr>").join("");
  const detalle=rows.slice(12,15).map(r=>r.slice(0,2));
  document.getElementById("tabla_tc_detalle").innerHTML =
    detalle.map(row=>"<tr>"+row.map(c=>`<td>${c}</td>`).join("")+"</tr>").join("");
}
async function cargarGas(){
  const resp=await fetch(csvUrl(GID_GAS));
  const rows=parseCSV(await resp.text());
  const top=rows.slice(0,5);
  const header=top[0]||[];
  let last=-1,prev=-1;
  for(let i=header.length-1;i>=1;i--){
    if(header[i]&&header[i].trim()!==""){ if(last===-1) last=i; else{prev=i; break;} }
  }
  if(last===-1) last=Math.max(1,header.length-1);
  if(prev===-1) prev=Math.max(1,last-1);
  const out=top.map(r=>{
    const cA=r[0]??"", cPrev=r[prev]??"", cLast=r[last]??"";
    return `<tr><td>${cA}</td><td>${cPrev}</td><td>${cLast}</td></tr>`;
  }).join("");
  document.getElementById("tabla_gas").innerHTML=out;
}
async function cargarHijas(){
  const resp=await fetch(csvUrl(GID_HIJAS));
  const rows=parseCSV(await resp.text());
  const datos=rows.slice(0,2).map(r=>r.slice(0,2));
  if(datos.length<2) return;
  const fila1=`<tr>${datos[0].map(c=>`<td>${c}</td>`).join("")}</tr>`;
  const fila2=`<tr>${datos[1].map(c=>{
    const num=parseFloat(c.replace(/,/g,""));
    const val=isNaN(num)?c: num.toLocaleString("es-CL");
    return `<td>${val}</td>`;
  }).join("")}</tr>`;
  document.getElementById("tabla_hijas").innerHTML=fila1+fila2;
}

// --- Swipe con animación estilo iOS ---
let startX=0,startY=0;
const minDistance=40; // más sensible
document.addEventListener("touchstart",e=>{
  if(e.touches.length===1){startX=e.touches[0].clientX;startY=e.touches[0].clientY;}
});
document.addEventListener("touchend",e=>{
  if(e.changedTouches.length===1){
    const dx=e.changedTouches[0].clientX-startX;
    const dy=e.changedTouches[0].clientY-startY;
    if(Math.abs(dx)>Math.abs(dy)&&Math.abs(dx)>minDistance){
      const views=["view-resumen","view-tc","view-gas","view-hijas"];
      const current=views.findIndex(v=>document.getElementById(v).classList.contains("active"));
      let next=current;
      if(dx<0&&current<views.length-1)next=current+1;
      else if(dx>0&&current>0)next=current-1;
      if(next!==current){
        const cur=document.getElementById(views[current]);
        const nxt=document.getElementById(views[next]);
        cur.style.transition="transform 0.4s cubic-bezier(0.25, 0.8, 0.5, 1)";
        nxt.style.transition="transform 0.4s cubic-bezier(0.25, 0.8, 0.5, 1)";
        cur.style.transform=dx<0?"translateX(-100%)":"translateX(100%)";
        nxt.style.transform="translateX(0)";
        document.querySelectorAll(".view").forEach(v=>v.classList.remove("active"));
        nxt.classList.add("active");
        const tabs=document.querySelectorAll(".tabbtn");
        tabs.forEach(b=>b.classList.remove("active"));
        tabs[next].classList.add("active");
        setTimeout(()=>{cur.style.transition="";cur.style.transform="";},400);
      }
    }
  }
});

// Carga inicial y actualización
cargarResumen(); cargarTC(); cargarGas(); cargarHijas();
setInterval(()=>{ cargarResumen(); cargarTC(); cargarGas(); cargarHijas(); },300000);
</script>
