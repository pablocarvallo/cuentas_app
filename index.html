<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DataApp Sheets CSV</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <link rel="apple-touch-icon" href="casa.png" />
    <meta name="apple-mobile-web-app-title" content="MiData">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
            --header-height: 50px;
        }
        body {
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            background-color: #f9fafb;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            font-size: 18px;
            overflow: hidden;
            height: 100vh;
            margin: 0;
            padding: 0;
        }
        
        /* Header fijo para el botón de refrescar */
        header {
            height: calc(var(--safe-top) + var(--header-height));
            background-color: #f9fafb;
            display: flex;
            align-items: flex-end;
            justify-content: flex-end;
            padding: 0 1rem 0.5rem 0;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }

        #swipe-container {
            margin-top: calc(var(--safe-top) + var(--header-height));
            height: calc(100vh - var(--safe-top) - var(--header-height) - 5rem - var(--safe-bottom));
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            touch-action: pan-y;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .active-tab-btn { color: #2563eb; border-top: 2px solid #2563eb; background-color: #eff6ff; }
        
        .pb-safe-extra { padding-bottom: calc(var(--safe-bottom) + 120px); }
        
        .data-row {
            padding: 0.85rem 1rem;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .data-row:nth-child(even) { background-color: #f8fafc; }

        .truncate-cell {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-shrink: 1;
            margin-right: 12px;
        }

        .value-cell {
            white-space: nowrap;
            flex-shrink: 0;
            text-align: right;
        }

        /* Ajuste del botón para que no flote sobre el contenido */
        .refresh-btn {
            background: white;
            padding: 6px;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border: 1px solid #e5e7eb;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .refresh-btn:active { transform: scale(0.9); }
        
        /* Asegurar que el header pegajoso de las tablas respete la nueva posición */
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="flex flex-col">

    <header>
        <button onclick="fetchData()" class="refresh-btn" aria-label="Refrescar">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
            </svg>
        </button>
    </header>

    <main id="swipe-container" class="flex-grow">
        <div id="loading" class="flex flex-col items-center justify-center py-20">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-2"></div>
            <p class="text-gray-500 text-sm">Cargando datos...</p>
        </div>
        
        <div id="tab1" class="tab-content active"><div id="content1" class="bg-white pb-safe-extra"></div></div>
        <div id="tab2" class="tab-content"><div id="content2" class="bg-white pb-safe-extra"></div></div>
        <div id="tab3" class="tab-content"><div id="content3" class="bg-white pb-safe-extra"></div></div>
        <div id="tab4" class="tab-content"><div id="content4" class="bg-white pb-safe-extra"></div></div>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around items-center h-20 shadow-[0_-2px_10px_rgba(0,0,0,0.05)] z-50" style="padding-bottom: var(--safe-bottom);">
        <button onclick="switchTab('tab1')" id="btn-tab1" class="flex flex-col items-center justify-center w-full h-full active-tab-btn transition-colors">
            <span class="text-[10px] font-bold uppercase">Resumen</span>
        </button>
        <button onclick="switchTab('tab2')" id="btn-tab2" class="flex flex-col items-center justify-center w-full h-full text-gray-400 transition-colors border-l">
            <span class="text-[10px] font-bold uppercase">TC</span>
        </button>
        <button onclick="switchTab('tab3')" id="btn-tab3" class="flex flex-col items-center justify-center w-full h-full text-gray-400 transition-colors border-l">
            <span class="text-[10px] font-bold uppercase">Master</span>
        </button>
        <button onclick="switchTab('tab4')" id="btn-tab4" class="flex flex-col items-center justify-center w-full h-full text-gray-400 transition-colors border-l">
            <span class="text-[10px] font-bold uppercase">LiderBCI</span>
        </button>
    </nav>

    <script>
        const URLS = {
            tab1: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT5uXYuDRWuBezPr8wkXCc07mT2DaJQxgYgw0z90JDlS58Io7efeB7KhUpOiALhBtjITBJnNUWJHEKt/pub?gid=189610331&single=true&output=csv',
            tab2: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT5uXYuDRWuBezPr8wkXCc07mT2DaJQxgYgw0z90JDlS58Io7efeB7KhUpOiALhBtjITBJnNUWJHEKt/pub?gid=70744574&single=true&output=csv',
            tab3: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT5uXYuDRWuBezPr8wkXCc07mT2DaJQxgYgw0z90JDlS58Io7efeB7KhUpOiALhBtjITBJnNUWJHEKt/pub?gid=878224959&single=true&output=csv'
        };

        const tabs = ['tab1', 'tab2', 'tab3', 'tab4'];
        let currentTabIndex = 0;

        function switchTab(tabId) {
            currentTabIndex = tabs.indexOf(tabId);
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('nav button').forEach(el => {
                el.classList.remove('active-tab-btn', 'text-gray-400');
                if (el.id !== 'btn-' + tabId) el.classList.add('text-gray-400');
            });
            document.getElementById(tabId).classList.add('active');
            document.getElementById('btn-' + tabId).classList.add('active-tab-btn');
            document.getElementById('swipe-container').scrollTop = 0;
        }

        let touchstartX = 0;
        let touchendX = 0;
        let touchstartY = 0;
        let touchendY = 0;

        const gestureZone = document.getElementById('swipe-container');

        gestureZone.addEventListener('touchstart', e => {
            touchstartX = e.changedTouches[0].screenX;
            touchstartY = e.changedTouches[0].screenY;
        }, {passive: true});

        gestureZone.addEventListener('touchend', e => {
            touchendX = e.changedTouches[0].screenX;
            touchendY = e.changedTouches[0].screenY;
            handleGesture();
        }, {passive: true});

        function handleGesture() {
            const deltaX = touchendX - touchstartX;
            const deltaY = touchendY - touchstartY;
            if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 60) {
                if (deltaX < 0) {
                    if (currentTabIndex < tabs.length - 1) switchTab(tabs[currentTabIndex + 1]);
                } else {
                    if (currentTabIndex > 0) switchTab(tabs[currentTabIndex - 1]);
                }
            }
        }

        function formatNumber(val) {
            if (!val) return '';
            const cleanVal = val.toString().trim().replace(/[$.]/g, '').replace(',', '.');
            const num = parseFloat(cleanVal);
            if (isNaN(num)) return val;
            return new Intl.NumberFormat('de-DE').format(num);
        }

        function parseCSV(text) {
            const lines = text.split(/\r?\n/);
            return lines.map(line => {
                const values = [];
                let current = '';
                let inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') inQuotes = !inQuotes;
                    else if (char === ',' && !inQuotes) {
                        values.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current.trim());
                return values;
            });
        }

        async function fetchData() {
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('loading').innerHTML = `
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-2"></div>
                <p class="text-gray-500 text-sm">Actualizando...</p>
            `;
            
            try {
                const cacheBuster = `&t=${new Date().getTime()}`;
                
                const [resResumen, resTC, resMaster] = await Promise.all([
                    fetch(URLS.tab1 + cacheBuster).then(r => r.text()),
                    fetch(URLS.tab2 + cacheBuster).then(r => r.text()),
                    fetch(URLS.tab3 + cacheBuster).then(r => r.text())
                ]);

                const csvResumen = parseCSV(resResumen);
                const csvTC = parseCSV(resTC);
                const csvMaster = parseCSV(resMaster);

                renderUnified(csvResumen.slice(0, 9), 'content1', 3, 4);
                renderUnified(csvTC.slice(0, 11), 'content2', 0, 1);
                renderUnified(csvMaster.slice(0, 200), 'content3', 0, 1);
                renderUnified(csvMaster.slice(0, 200), 'content4', 3, 4);

                document.getElementById('loading').style.display = 'none';
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loading').innerHTML = `<div class="p-6 text-red-600 text-center">Error de red. Reintente.</div>`;
            }
        }

        function renderUnified(rows, containerId, labelIdx, valueIdx) {
            const container = document.getElementById(containerId);
            container.innerHTML = rows.map((row, index) => {
                const label = row[labelIdx] || "";
                const rawValue = row[valueIdx] || "";
                if(!label && !rawValue) return "";
                const isHeader = index === 0;
                const valueDisplay = isHeader ? rawValue : formatNumber(rawValue);
                return `
                    <div class="data-row ${isHeader ? 'bg-blue-600 text-white font-bold sticky-header' : ''}">
                        <span class="truncate-cell ${isHeader ? 'text-white' : 'text-gray-700 font-medium'}">${label}</span>
                        <span class="value-cell ${isHeader ? 'text-white' : 'text-blue-600 font-bold'} font-mono">${valueDisplay}</span>
                    </div>
                `;
            }).join('');
        }

        window.onload = fetchData;
    </script>
</body>
</html>
